---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { marked } from 'marked';

export async function getStaticPaths() {
  const reviewEntries = await getCollection('review');
  return reviewEntries.map(entry => ({
    params: { id: entry.slug },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const categoryNames = {
  gadget: 'ガジェット',
  book: '本'
};

function renderStars(rating) {
  return '★'.repeat(rating) + '☆'.repeat(5 - rating);
}

// Process markdown fields
const processedRecommendFor = entry.data.recommendFor ? marked(entry.data.recommendFor) : null;
const processedNotRecommendFor = entry.data.notRecommendFor ? marked(entry.data.notRecommendFor) : null;
const processedGoodPoints = entry.data.goodPoints ? marked(entry.data.goodPoints) : null;
const processedBadPoints = entry.data.badPoints ? marked(entry.data.badPoints) : null;
---

<Layout title={`${entry.data.title} - レビュー - TRPG研究室`}>
  <nav class="breadcrumb">
    <a href="/">ホーム</a> &gt; 
    <a href="/review">レビュー</a> &gt; 
    <a href={`/review/${entry.data.category}`}>{categoryNames[entry.data.category]}</a> &gt; 
    <span class="current">{entry.data.title}</span>
  </nav>

  <article>
    <header>
      <h1>{entry.data.title}</h1>
      <div class="meta">
        <span class="category">{categoryNames[entry.data.category]}</span>
        <span class="rating">{renderStars(entry.data.rating)} ({entry.data.rating}/5)</span>
        <span class="date">公開日: {entry.data.publishedAt.toISOString().split('T')[0]}</span>
      </div>
      
      <div class="links">
        {entry.data.officialUrl && (
          <a href={entry.data.officialUrl} target="_blank" rel="noopener noreferrer" class="official-link">
            公式サイト
          </a>
        )}
        {entry.data.amazonUrl && (
          <a href={entry.data.amazonUrl} target="_blank" rel="noopener noreferrer" class="amazon-link">
            Amazon
          </a>
        )}
      </div>
    </header>

    <div class="review-sections">
      {processedRecommendFor && (
        <section class="recommend-section">
          <h3>おすすめする人</h3>
          <div set:html={processedRecommendFor} />
        </section>
      )}

      {processedNotRecommendFor && (
        <section class="not-recommend-section">
          <h3>おすすめしない人</h3>
          <div set:html={processedNotRecommendFor} />
        </section>
      )}

      {processedGoodPoints && (
        <section class="good-points-section">
          <h3>良かった点</h3>
          <div set:html={processedGoodPoints} />
        </section>
      )}

      {processedBadPoints && (
        <section class="bad-points-section">
          <h3>悪かった点</h3>
          <div set:html={processedBadPoints} />
        </section>
      )}
    </div>

    <div class="content">
      <h3>詳細レビュー</h3>
      <Content />
    </div>
  </article>

  <nav class="back-link">
    <a href="/review">← レビュー一覧に戻る</a>
  </nav>

  <style>
    .breadcrumb {
      margin-bottom: 1rem;
      color: #666;
      font-size: 0.9rem;
    }
    .breadcrumb a {
      color: #3498db;
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    .breadcrumb .current {
      font-weight: bold;
    }
    article header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    article h1 {
      margin: 0 0 1rem 0;
      color: #2c3e50;
    }
    .meta {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .meta .category {
      background-color: #e74c3c;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    .meta .rating {
      color: #f39c12;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .meta .date {
      color: #666;
      font-size: 0.9rem;
    }
    .links {
      margin-top: 1rem;
    }
    .links a {
      display: inline-block;
      padding: 0.5rem 1rem;
      margin-right: 1rem;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s;
    }
    .official-link {
      background-color: #3498db;
      color: white;
    }
    .official-link:hover {
      background-color: #2980b9;
    }
    .amazon-link {
      background-color: #ff9900;
      color: white;
    }
    .amazon-link:hover {
      background-color: #e68900;
    }
    .review-sections {
      margin: 2rem 0;
    }
    .review-sections section {
      margin: 1.5rem 0;
      padding: 1.5rem;
      border-radius: 8px;
    }
    .recommend-section {
      background-color: #d5f4e6;
      border-left: 4px solid #27ae60;
    }
    .not-recommend-section {
      background-color: #fadbd8;
      border-left: 4px solid #e74c3c;
    }
    .good-points-section {
      background-color: #d4edda;
      border-left: 4px solid #28a745;
    }
    .bad-points-section {
      background-color: #f8d7da;
      border-left: 4px solid #dc3545;
    }
    .review-sections h3 {
      margin: 0 0 1rem 0;
      color: #2c3e50;
      font-size: 1.1rem;
    }
    .content {
      margin: 2rem 0;
      line-height: 1.8;
    }
    .content h3 {
      color: #2c3e50;
      margin-bottom: 1rem;
      border-bottom: 2px solid #3498db;
      padding-bottom: 0.5rem;
    }
    .content h1, .content h2, .content h4, .content h5, .content h6 {
      color: #2c3e50;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    .content p {
      margin-bottom: 1rem;
    }
    .content ul, .content ol {
      margin-bottom: 1rem;
      padding-left: 2rem;
    }
    .back-link {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }
    .back-link a {
      color: #3498db;
      text-decoration: none;
    }
    .back-link a:hover {
      text-decoration: underline;
    }
  </style>
</Layout>

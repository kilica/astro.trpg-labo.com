---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { marked } from 'marked';
import '../../styles/review.css';

export async function getStaticPaths() {
  const reviewEntries = await getCollection('review');
  return reviewEntries.map(entry => ({
    params: { id: entry.slug },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const categoryNames = {
  gadget: 'ガジェット',
  book: '本'
};

function renderStars(rating) {
  return '★'.repeat(rating) + '☆'.repeat(5 - rating);
}

// Process markdown fields
const processedRecommendFor = entry.data.recommendFor ? marked(entry.data.recommendFor) : null;
const processedNotRecommendFor = entry.data.notRecommendFor ? marked(entry.data.notRecommendFor) : null;
const processedGoodPoints = entry.data.goodPoints ? marked(entry.data.goodPoints) : null;
const processedBadPoints = entry.data.badPoints ? marked(entry.data.badPoints) : null;
---

<Layout title={`${entry.data.title} - レビュー - TRPG研究室`}>
  <nav class="breadcrumb">
    <a href="/">ホーム</a> &gt; 
    <a href="/review">レビュー</a> &gt; 
    <a href={`/review/${entry.data.category}`}>{categoryNames[entry.data.category]}</a> &gt; 
    <span class="current">{entry.data.title}</span>
  </nav>

  <article>
    <header>
      <h1>{entry.data.title}</h1>
      <div class="meta">
        <span class="category">{categoryNames[entry.data.category]}</span>
        <span class="rating">{renderStars(entry.data.rating)} ({entry.data.rating}/5)</span>
        <span class="date">公開日: {entry.data.publishedAt.toISOString().split('T')[0]}</span>
      </div>
      
      {entry.data.isbn && (
        <div class="isbn">
          <strong>ISBN:</strong> {entry.data.isbn}
        </div>
      )}
      
      <div class="links">
        {entry.data.officialUrl && (
          <a href={entry.data.officialUrl} target="_blank" rel="noopener noreferrer" class="official-link">
            公式サイト
          </a>
        )}
        {entry.data.amazonUrl && (
          <a href={entry.data.amazonUrl} target="_blank" rel="noopener noreferrer" class="amazon-link">
            Amazon
          </a>
        )}
      </div>
    </header>

    <div class="review-sections">
      {processedRecommendFor && (
        <section class="recommend-section">
          <h3>おすすめする人</h3>
          <div set:html={processedRecommendFor} />
        </section>
      )}

      {processedNotRecommendFor && (
        <section class="not-recommend-section">
          <h3>おすすめしない人</h3>
          <div set:html={processedNotRecommendFor} />
        </section>
      )}

      {processedGoodPoints && (
        <section class="good-points-section">
          <h3>良かった点</h3>
          <div set:html={processedGoodPoints} />
        </section>
      )}

      {processedBadPoints && (
        <section class="bad-points-section">
          <h3>悪かった点</h3>
          <div set:html={processedBadPoints} />
        </section>
      )}
    </div>

    <div class="content">
      <h2>レビュー</h2>
      <div class="review-body">
        <Content />
      </div>
    </div>
  </article>

  <nav class="back-link">
    <a href="/review">← レビュー一覧に戻る</a>
  </nav>
</Layout>

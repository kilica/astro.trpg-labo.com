---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const laboEntries = await getCollection('labo');

// Group by category
const categories = {
  general: laboEntries.filter(entry => entry.data.category === 'general'),
  scenariomaking: laboEntries.filter(entry => entry.data.category === 'scenariomaking'),
  system: laboEntries.filter(entry => entry.data.category === 'system')
};

const categoryNames = {
  general: '全般',
  scenariomaking: 'シナリオ作成',
  system: 'システム'
};

// Function to build hierarchy
function buildHierarchy(entries) {
  const entryMap = new Map();
  const roots = [];
  
  // Create map of all entries
  entries.forEach(entry => {
    entryMap.set(entry.slug, { ...entry, children: [] });
  });
  
  // Build hierarchy
  entries.forEach(entry => {
    const item = entryMap.get(entry.slug);
    if (entry.data.parent) {
      const parent = entryMap.get(entry.data.parent);
      if (parent) {
        parent.children.push(item);
      } else {
        roots.push(item);
      }
    } else {
      roots.push(item);
    }
  });
  
  // Sort by order
  function sortByOrder(items) {
    items.sort((a, b) => a.data.order - b.data.order);
    items.forEach(item => sortByOrder(item.children));
  }
  
  sortByOrder(roots);
  return roots;
}
---

<Layout title="研究室 - TRPG研究室">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-90 mb-4">研究室</h1>
    <p class="text-75">TRPGに関する研究や情報をカテゴリ別にまとめています。</p>
  </div>

  {Object.entries(categories).map(([categoryKey, entries]) => (
    entries.length > 0 && (
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-90 mb-6 pb-2 border-b border-[var(--line-divider)]">
          {categoryNames[categoryKey]}
        </h2>
        <div class="space-y-4">
          {buildHierarchy(entries).map(entry => (
            <div class="card border-l-4 border-[var(--primary)]">
              <h3 class="text-lg font-semibold mb-2">
                <a href={`/labo/${entry.slug}`} class="link-underline text-90 hover:text-[var(--primary)]">
                  {entry.data.title}
                </a>
              </h3>
              <div class="meta mb-3">
                <span class="text-50">{entry.data.publishedAt.toISOString().split('T')[0]}</span>
              </div>
              {entry.children.length > 0 && (
                <div class="ml-6 pl-4 border-l-2 border-[var(--line-divider)] space-y-3">
                  {entry.children.map(child => (
                    <div class="card !p-3 bg-[var(--btn-regular-bg)]">
                      <h4 class="text-base font-medium mb-1">
                        <a href={`/labo/${child.slug}`} class="link-underline text-90 hover:text-[var(--primary)]">
                          {child.data.title}
                        </a>
                      </h4>
                      <div class="meta">
                        <span class="text-50 text-sm">{child.data.publishedAt.toISOString().split('T')[0]}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>
      </section>
    )
  ))}
</Layout>
